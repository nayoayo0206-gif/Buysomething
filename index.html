import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, onSnapshot, query, addDoc } from 'firebase/firestore';
import { Settings, BarChart2, List, Trash2, Edit2, Share2, X, Camera, CheckCircle2, Circle, ShieldCheck, AlertCircle, ShoppingBag, Users, Tag } from 'lucide-react';
import Chart from 'chart.js/auto';

// --- Firebase 配置 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-shopping-app-v3';

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('list'); 
  const [statMode, setStatMode] = useState('category'); 
  const [items, setItems] = useState([]);
  const [targets, setTargets] = useState(["自己", "家人", "朋友"]);
  const [cats, setCats] = useState(["藥妝", "零食", "精品"]);
  
  const [selT, setSelT] = useState("自己");
  const [selC, setSelC] = useState("藥妝");
  const [name, setName] = useState("");
  const [price, setPrice] = useState("");
  const [currency, setCurrency] = useState("TWD");
  const [img, setImg] = useState(null);
  const [editingId, setEditingId] = useState(null);
  const [rates, setRates] = useState({ KRW: 41, JPY: 4.6, USD: 0.031 });
  const [showSettings, setShowSettings] = useState(false);
  
  const [deleteConfirmId, setDeleteConfirmId] = useState(null);
  const [shareLoading, setShareLoading] = useState(false);

  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // 初始化 Auth
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error("Auth Error:", e); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 監聽 Firestore 數據
  useEffect(() => {
    if (!user) return;
    const itemsCol = collection(db, 'artifacts', appId, 'users', user.uid, 'items');
    const unsubItems = onSnapshot(itemsCol, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setItems(data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)));
    });

    const setDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'tags');
    const unsubSettings = onSnapshot(setDocRef, (snap) => {
      if (snap.exists()) {
        const d = snap.data();
        if (d.targets) setTargets(d.targets);
        if (d.cats) setCats(d.cats);
      }
    });
    return () => { unsubItems(); unsubSettings(); };
  }, [user]);

  // 獲取最新匯率
  useEffect(() => {
    fetch('https://open.er-api.com/v6/latest/TWD')
      .then(r => r.json())
      .then(d => setRates(d.rates));
  }, []);

  // 統計數據計算
  const stats = useMemo(() => {
    const boughtItems = items.filter(i => i.bought);
    const spent = boughtItems.reduce((a, b) => a + (b.priceInTWD || 0), 0);
    const wish = items.filter(i => !i.bought).reduce((a, b) => a + (b.priceInTWD || 0), 0);

    const dataMap = {};
    const key = statMode === 'category' ? 'category' : 'target';
    boughtItems.forEach(item => {
      const val = item[key] || "未分類";
      dataMap[val] = (dataMap[val] || 0) + (item.priceInTWD || 0);
    });

    return { spent, wish, dataMap };
  }, [items, statMode]);

  // 統計圓餅圖
  useEffect(() => {
    if (view === 'stats' && chartRef.current && Object.keys(stats.dataMap).length > 0) {
      if (chartInstance.current) chartInstance.current.destroy();
      const labels = Object.keys(stats.dataMap);
      const data = Object.values(stats.dataMap);
      chartInstance.current = new Chart(chartRef.current, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: ['#FFFFFF', '#D1D1D6', '#8E8E93', '#48484A', '#2C2C2E', '#636366', '#3A3A3C'],
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: { 
          cutout: '75%', 
          plugins: { legend: { display: false } },
          animation: { duration: 800 }
        }
      });
    }
  }, [view, stats.dataMap]);

  // 重置輸入欄位的核心函式
  const resetInputFields = () => {
    setName("");
    setPrice("");
    setImg(null);
    setEditingId(null);
    // 強制 UI 更新
  };

  // 處理儲存
  const handleSave = async () => {
    if (!name || !user) return;
    
    // 先暫存目前需要儲存的資料
    const p = parseFloat(price) || 0;
    const twd = currency === 'TWD' ? p : (p / (rates[currency] || 1));
    const data = { 
      name: name.trim(), 
      price: p, 
      currency, 
      target: selT, 
      category: selC, 
      priceInTWD: twd, 
      image: img, 
      updatedAt: Date.now() 
    };
    
    try {
      if (editingId) {
        // 編輯模式
        const itemRef = doc(db, 'artifacts', appId, 'users', user.uid, 'items', editingId);
        await updateDoc(itemRef, data);
      } else {
        // 新增模式
        const itemsCol = collection(db, 'artifacts', appId, 'users', user.uid, 'items');
        await addDoc(itemsCol, { 
          ...data, 
          bought: false, 
          createdAt: Date.now() 
        });
      }
      // 確保在 AWAIT 之後執行清空
      resetInputFields();
    } catch (e) { 
      console.error("Save Error:", e);
      // 如果出錯也要重置嗎？通常會保留讓使用者重試，但這裡為了確保行為一致可以保留，或提示錯誤
    }
  };

  const toggleBought = async (item) => {
    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'items', item.id), { bought: !item.bought });
  };

  const confirmDelete = async () => {
    if (!deleteConfirmId || !user) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'items', deleteConfirmId));
    setDeleteConfirmId(null);
  };

  const handleLineShare = async (item) => {
    if (!user) return;
    setShareLoading(true);
    try {
      const publicRef = collection(db, 'artifacts', appId, 'public', 'data', 'shared_items');
      const newDoc = await addDoc(publicRef, { ...item, sharedBy: user.uid, sharedAt: Date.now(), appTitle: "(˶˙๏˙˶)b" });
      const shareUrl = `${window.location.origin}${window.location.pathname}?shareId=${newDoc.id}`;
      const message = `✨ 我在「My購了沒」發現好物！\n\n品項：${item.name}\n預算：${item.currency} ${item.price}\n對象：${item.target}\n分類：${item.category}\n\n看更多細節：${shareUrl}`;
      const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
      window.location.href = lineUrl;
    } catch (e) { console.error(e); setShareLoading(false); }
  };

  const updateTags = async (newT, newC) => {
    if (!user) return;
    setTargets(newT); setCats(newC);
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'tags'), { targets: newT, cats: newC });
  };

  return (
    <div className="min-h-screen bg-[#050505] text-white pb-40 font-sans selection:bg-white selection:text-black">
      <header className="sticky top-0 z-40 bg-black/90 backdrop-blur-3xl border-b border-white/5 px-6 py-7">
        <div className="max-w-xl mx-auto flex justify-between items-center">
          <h1 className="text-xl font-black tracking-[0.25em] text-white/95 uppercase">
            My購了沒<span className="ml-1 opacity-70 lowercase">(˶˙๏˙˶)b</span>
          </h1>
          <button onClick={() => setShowSettings(true)} className="p-3 bg-white/5 rounded-full border border-white/10 active:scale-90 transition-all hover:bg-white/10">
            <Settings size={20} />
          </button>
        </div>
      </header>

      <main className="max-w-xl mx-auto px-5 pt-6 space-y-10">
        <section className="flex gap-4">
          <div className="flex-1 bg-zinc-900/60 p-6 rounded-[2.2rem] border border-white/10 shadow-xl">
            <p className="text-[10px] font-black text-white/70 uppercase tracking-[0.3em] mb-2 drop-shadow-sm">已花費</p>
            <p className="text-2xl font-black font-mono tracking-tight">${Math.round(stats.spent).toLocaleString()}</p>
          </div>
          <div className="flex-1 bg-zinc-900/20 p-6 rounded-[2.2rem] border border-white/5">
            <p className="text-[10px] font-black text-white/40 uppercase tracking-[0.3em] mb-2 drop-shadow-sm">預計花費</p>
            <p className="text-2xl font-black text-white/40 font-mono tracking-tight">${Math.round(stats.wish).toLocaleString()}</p>
          </div>
        </section>

        {view === 'list' && (
          <>
            <section className="space-y-6 bg-zinc-950/50 p-6 rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden">
              <div className="space-y-4">
                <div className="overflow-x-auto no-scrollbar -my-1 py-3 px-1">
                  <div className="flex gap-3">
                    {targets.map(t => (
                      <button 
                        key={t} 
                        onClick={() => setSelT(t)} 
                        className={`px-5 py-2.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all flex-none transform ${selT === t ? 'bg-white text-black scale-110 shadow-[0_4px_12px_rgba(255,255,255,0.15)] z-10' : 'bg-white/5 text-white/30'}`}
                      >
                        {t}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="overflow-x-auto no-scrollbar -my-1 py-3 px-1">
                  <div className="flex gap-3">
                    {cats.map(c => (
                      <button 
                        key={c} 
                        onClick={() => setSelC(c)} 
                        className={`px-5 py-2.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all flex-none transform ${selC === c ? 'bg-zinc-800 text-white border border-white/20 scale-110 shadow-xl z-10' : 'bg-white/5 text-white/30'}`}
                      >
                        {c}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
              
              <div className="space-y-4">
                <input value={name} onChange={e => setName(e.target.value)} placeholder="品項名稱..." className="w-full bg-white/5 border-none rounded-2xl py-5 px-6 text-sm font-black focus:ring-1 focus:ring-white/10 placeholder:text-white/10" />
                <div className="flex bg-white/5 rounded-2xl px-5 items-center w-full overflow-hidden border border-transparent focus-within:border-white/10 transition-colors">
                  <div className="flex-none pr-3 border-r border-white/5 py-3">
                    <select value={currency} onChange={e => setCurrency(e.target.value)} className="bg-transparent border-none text-[11px] font-black focus:ring-0 pl-0 pr-2 text-white/60 uppercase tracking-widest cursor-pointer appearance-none">
                      <option>TWD</option><option>KRW</option><option>JPY</option><option>USD</option>
                    </select>
                  </div>
                  <div className="flex-1 min-w-0">
                    <input type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="0" className="w-full bg-transparent border-none py-5 text-right font-black text-xl font-mono focus:ring-0 pr-1 placeholder:text-white/10" />
                  </div>
                </div>
              </div>

              <div className="flex gap-3 pt-2">
                <button onClick={() => document.getElementById('cam-in').click()} className="flex-1 h-16 bg-white/5 rounded-2xl flex items-center justify-center text-[10px] font-black uppercase text-white/40 gap-3 border border-white/5 active:bg-white/10 transition-colors">
                  <Camera size={18} /> {img ? "已選照片" : "相機"}
                </button>
                <button onClick={handleSave} className={`px-14 h-16 rounded-2xl font-black text-[11px] uppercase tracking-[0.2em] active:scale-95 shadow-xl transition-all ${editingId ? 'bg-yellow-400 text-black' : 'bg-white text-black'}`}>
                  {editingId ? "儲存" : "新增"}
                </button>
                <input type="file" id="cam-in" className="hidden" accept="image/*" onChange={(e) => {
                  const f = e.target.files[0];
                  if (f) { const r = new FileReader(); r.onload = (ev) => setImg(ev.target.result); r.readAsDataURL(f); }
                }} />
              </div>
              {editingId && <button onClick={resetInputFields} className="w-full py-2 text-[9px] font-black text-white/20 uppercase tracking-widest hover:text-white transition-colors">取消編輯並返回新增</button>}
            </section>

            <div className="space-y-12 pt-10">
              {items.map(item => (
                <div key={item.id} className="bg-zinc-900/30 rounded-[2.8rem] border border-white/5 overflow-hidden shadow-lg shadow-black">
                  <div className={`transition-opacity duration-500 ${item.bought ? 'opacity-30' : 'opacity-100'}`}>
                    <div className="relative h-72 w-full bg-zinc-950 flex items-center justify-center overflow-hidden">
                      {item.image ? <img src={item.image} className="w-full h-full object-cover" alt={item.name} /> : <div className="text-white/[0.03] font-black text-6xl uppercase tracking-widest">BUY</div>}
                      <div className="absolute top-6 left-6 flex flex-wrap gap-2">
                        <span className="bg-white/95 backdrop-blur-md text-black px-4 py-2 rounded-full text-[9px] font-black tracking-widest uppercase shadow-sm">{item.target}</span>
                        <span className="bg-black/60 backdrop-blur-md text-white/80 px-4 py-2 rounded-full text-[9px] font-black tracking-widest uppercase border border-white/10 shadow-sm">{item.category}</span>
                      </div>
                    </div>
                    <div className="px-8 pt-8 pb-4">
                      <div className="flex justify-between items-start gap-4">
                        <div className="space-y-2 flex-1 min-w-0">
                          <h3 className="text-2xl font-black tracking-tight leading-tight truncate">{item.name}</h3>
                          <div className="flex items-baseline gap-3">
                            <span className="text-3xl font-mono font-black tracking-tighter">${Math.round(item.priceInTWD || 0).toLocaleString()}</span>
                          </div>
                        </div>
                        <button onClick={() => toggleBought(item)} className={`flex items-center gap-3 px-8 py-4 rounded-full text-[10px] font-black uppercase transition-all shadow-xl active:scale-95 whitespace-nowrap flex-none ${item.bought ? 'bg-white text-black' : 'bg-zinc-800 text-white/80 border border-white/10'}`}>
                          {item.bought ? <CheckCircle2 size={16}/> : <Circle size={16}/>}
                          {item.bought ? '已買' : '要買'}
                        </button>
                      </div>
                    </div>
                  </div>
                  <div className="px-8 pb-8">
                    <div className="flex gap-3 pt-4 border-t border-white/[0.03]">
                      <button onClick={() => {setEditingId(item.id); setName(item.name); setPrice(item.price.toString()); setCurrency(item.currency); setSelT(item.target); setSelC(item.category); setImg(item.image); window.scrollTo({top:0, behavior:'smooth'})}} className="flex-1 flex items-center justify-center gap-2 py-4 bg-white/[0.03] rounded-2xl text-[9px] font-black uppercase tracking-widest text-white/40 hover:text-white transition-all active:scale-95 border border-transparent hover:border-white/5">
                        <Edit2 size={14}/> 編輯
                      </button>
                      <button onClick={() => handleLineShare(item)} className="flex-1 flex items-center justify-center gap-2 py-4 bg-green-500/10 rounded-2xl text-[9px] font-black uppercase tracking-widest text-green-400/80 hover:text-green-400 transition-all border border-green-500/5 active:scale-95">
                        <Share2 size={14}/> LINE
                      </button>
                      <button onClick={() => setDeleteConfirmId(item.id)} className="flex-1 flex items-center justify-center gap-2 py-4 bg-red-500/10 rounded-2xl text-[9px] font-black uppercase tracking-widest text-red-400/80 hover:text-red-400 transition-all border border-red-500/5 active:scale-95">
                        <Trash2 size={14}/> 刪除
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </>
        )}

        {view === 'stats' && (
          <div className="py-10 space-y-12 animate-in fade-in duration-500">
            <div className="flex bg-white/5 p-2 rounded-3xl border border-white/5">
              <button onClick={() => setStatMode('category')} className={`flex-1 flex items-center justify-center gap-3 py-4 rounded-2xl text-[11px] font-black uppercase tracking-[0.1em] transition-all ${statMode === 'category' ? 'bg-white text-black shadow-lg shadow-white/5' : 'text-white/30 hover:text-white/60'}`}><Tag size={16} /> 按類別</button>
              <button onClick={() => setStatMode('target')} className={`flex-1 flex items-center justify-center gap-3 py-4 rounded-2xl text-[11px] font-black uppercase tracking-[0.1em] transition-all ${statMode === 'target' ? 'bg-white text-black shadow-lg shadow-white/5' : 'text-white/30 hover:text-white/60'}`}><Users size={16} /> 按對象</button>
            </div>
            <div className="relative w-80 h-80 mx-auto">
              <canvas ref={chartRef}></canvas>
              <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <p className="text-[10px] font-black text-white/50 uppercase tracking-[0.5em] mb-1">已購總計</p>
                <p className="text-4xl font-black font-mono">${Math.round(stats.spent).toLocaleString()}</p>
              </div>
            </div>
            <div className="space-y-6">
              <p className="text-[10px] font-black text-white/50 uppercase tracking-[0.6em] text-center mb-6">{statMode === 'category' ? '分類花費明細' : '對象花費明細'}</p>
              <div className="space-y-3">
                {Object.entries(stats.dataMap).sort((a,b) => b[1] - a[1]).map(([label, amount], i) => (
                  <div key={label} className="bg-zinc-900/40 p-6 rounded-3xl border border-white/5 flex justify-between items-center transition-all hover:bg-zinc-900/60">
                     <div className="flex items-center gap-4">
                        <div className="w-2.5 h-2.5 rounded-full shadow-sm" style={{backgroundColor: ['#FFFFFF', '#D1D1D6', '#8E8E93', '#48484A', '#2C2C2E', '#636366', '#3A3A3C'][i % 7]}}></div>
                        <div className="flex flex-col">
                          <span className="text-[11px] font-black uppercase tracking-widest text-white/80">{label}</span>
                          <span className="text-[8px] font-bold text-white/20 uppercase tracking-widest">佔比 {Math.round((amount / (stats.spent || 1)) * 100)}%</span>
                        </div>
                     </div>
                     <span className="font-mono font-black text-lg">${Math.round(amount).toLocaleString()}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </main>

      <nav className="fixed bottom-12 inset-x-0 flex justify-center z-50 px-6">
        <div className="bg-black/80 backdrop-blur-3xl px-16 py-7 rounded-full border border-white/10 flex gap-28 shadow-2xl items-center">
          <button onClick={() => setView('list')} className={`flex flex-col items-center gap-2 transition-colors ${view === 'list' ? 'text-white' : 'text-white/20'}`}><List size={24}/></button>
          <button onClick={() => setView('stats')} className={`flex flex-col items-center gap-2 transition-colors ${view === 'stats' ? 'text-white' : 'text-white/20'}`}><BarChart2 size={24}/></button>
        </div>
      </nav>

      {/* 刪除確認框 */}
      {deleteConfirmId && (
        <div className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-md flex items-center justify-center p-10">
          <div className="bg-zinc-900 border border-white/10 p-10 rounded-[2.8rem] w-full max-w-sm space-y-8 text-center shadow-2xl">
            <div className="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto text-red-500"><AlertCircle size={40} /></div>
            <div className="space-y-2">
              <h3 className="text-xl font-black tracking-widest uppercase">移除品項？</h3>
              <p className="text-[10px] text-white/40 font-bold uppercase tracking-widest">此動作無法復原</p>
            </div>
            <div className="flex flex-col gap-3">
              <button onClick={confirmDelete} className="py-5 bg-red-500 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] active:scale-95 transition-all">確認移除</button>
              <button onClick={() => setDeleteConfirmId(null)} className="py-5 bg-white/5 text-white/60 rounded-2xl font-black text-xs uppercase tracking-[0.2em]">取消</button>
            </div>
          </div>
        </div>
      )}

      {/* 設定 */}
      {showSettings && (
        <div className="fixed inset-0 z-[100] bg-[#050505]/98 backdrop-blur-3xl flex flex-col p-10 overflow-y-auto">
          <div className="max-w-md mx-auto w-full space-y-16 py-10">
            <div className="flex justify-between items-center">
              <h2 className="text-2xl font-black tracking-[0.3em] uppercase">設定</h2>
              <button onClick={() => setShowSettings(false)} className="bg-white text-black w-14 h-14 rounded-full flex items-center justify-center active:scale-90 shadow-lg"><X size={26}/></button>
            </div>
            <div className="space-y-8">
              <div className="space-y-4">
                 <p className="text-[10px] font-black text-white/40 uppercase tracking-[0.6em] pl-1">對象標籤</p>
                 <div className="flex flex-wrap gap-2">
                    {targets.map(t => (
                      <div key={t} className="bg-white/5 px-4 py-3 rounded-xl text-[11px] font-black flex items-center gap-3 border border-white/5">
                        {t} <X size={14} className="text-white/20 cursor-pointer hover:text-red-500" onClick={() => updateTags(targets.filter(x => x!==t), cats)}/>
                      </div>
                    ))}
                    <button onClick={() => {const n = prompt("新增對象："); if(n) updateTags([...targets, n], cats)}} className="px-5 py-3 rounded-xl text-[11px] font-black bg-white/10 text-white/40">+</button>
                 </div>
              </div>
              <div className="space-y-4">
                 <p className="text-[10px] font-black text-white/40 uppercase tracking-[0.6em] pl-1">分類標籤</p>
                 <div className="flex flex-wrap gap-2">
                    {cats.map(c => (
                      <div key={c} className="bg-white/5 px-4 py-3 rounded-xl text-[11px] font-black flex items-center gap-3 border border-white/5">
                        {c} <X size={14} className="text-white/20 cursor-pointer hover:text-red-500" onClick={() => updateTags(targets, cats.filter(x => x!==c))}/>
                      </div>
                    ))}
                    <button onClick={() => {const n = prompt("新增分類："); if(n) updateTags(targets, [...cats, n])}} className="px-5 py-3 rounded-xl text-[11px] font-black bg-white/10 text-white/40">+</button>
                 </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {shareLoading && (
        <div className="fixed inset-0 z-[300] bg-black/50 backdrop-blur-sm flex items-center justify-center">
          <div className="bg-white text-black px-10 py-5 rounded-full font-black text-[10px] uppercase tracking-[0.3em] animate-pulse">正在啟動 LINE 分享...</div>
        </div>
      )}
    </div>
  );
}

